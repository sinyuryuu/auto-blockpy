<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Block測試</title>


    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    

    <script
      src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
      integrity="sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8="
      crossorigin="anonymous"
    ></script>

    <!-- bootstarp -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />

    <!-- Blockly -->

    <script
      src="lib/blockly/blockly_compressed.js"
      type="text/javascript"
    ></script>
    <script
      src="lib/blockly/blocks_compressed.js"
      type="text/javascript"
    ></script>
    <script src="lib/blockly/zh-hant.js" type="text/javascript"></script>
    <script
      src="lib/blockly/python_compressed.js"
      type="text/javascript"
    ></script>
    <script
      src="lib/blockly/custom_category.js"
      type="text/javascript"
    ></script>
    <script src="lib/blockly/toolbox_label_es6.js"></script>
    <!-- <link rel="stylesheet" href="lib/blockly/s3-dark.css"> -->
    <link rel="stylesheet" href="lib/blockly/toolbox_style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link rel="stylesheet" href="src/style.css" />


    <!-- Skulpt -->
    <script src="lib/skulpt/skulpt.js" type="text/javascript"></script>
    <script src="lib/skulpt/skulpt-stdlib.js" type="text/javascript"></script>
    <!-- <script src="lib/skulpt/skulpt_parser.js" type="text/javascript"></script>
 -->

    <!-- CodeMirror -->
    <link rel="stylesheet" href="lib/codemirror/codemirror.css" />
    <link rel="stylesheet" href="lib/codemirror/monokai.css" />
    <!-- <link rel="stylesheet" href="lib/codemirror/fullscreen.css"> -->
    <script src="lib/codemirror/codemirror.js" type="text/javascript"></script>
    <script src="lib/codemirror/python.js" type="text/javascript"></script>

    <!-- dev mode -->

    <!-- BlockMirror -->
    <link rel="stylesheet" href="lib/blockmirror/block_mirror.css" />
    <!-- <script src="lib/blockmirror/block_mirror.js" type="text/javascript"></script>-->

    <script src="src/blockly_shims.js" type="text/javascript"></script>
    <script src="src/block_mirror.js" type="text/javascript"></script>
    <script src="src/text_editor.js" type="text/javascript"></script>
    <script src="src/block_editor.js" type="text/javascript"></script>
    <script src="src/text_to_blocks.js" type="text/javascript"></script>
    <script src="src/ast/ast_functions.js" type="text/javascript"></script>
    <script src="src/toolbars.js" type="text/javascript"></script>

    <script src="src/ast/ast_For.js" type="text/javascript"></script>
    <script src="src/ast/ast_If.js" type="text/javascript"></script>
    <script src="src/ast/ast_While.js" type="text/javascript"></script>
    <script src="src/ast/ast_Num.js" type="text/javascript"></script>
    <script src="src/ast/ast_BinOp.js" type="text/javascript"></script>
    <script src="src/ast/ast_Name.js" type="text/javascript"></script>
    <script src="src/ast/ast_Assign.js" type="text/javascript"></script>
    <script src="src/ast/ast_AnnAssign.js" type="text/javascript"></script>
    <script src="src/ast/ast_AugAssign.js" type="text/javascript"></script>
    <script src="src/ast/ast_Str.js" type="text/javascript"></script>
    <script src="src/ast/ast_Expr.js" type="text/javascript"></script>
    <script src="src/ast/ast_UnaryOp.js" type="text/javascript"></script>
    <script src="src/ast/ast_BoolOp.js" type="text/javascript"></script>
    <script src="src/ast/ast_Compare.js" type="text/javascript"></script>
    <script src="src/ast/ast_Assert.js" type="text/javascript"></script>
    <script src="src/ast/ast_NameConstant.js" type="text/javascript"></script>
    <script src="src/ast/ast_List.js" type="text/javascript"></script>
    <script src="src/ast/ast_Tuple.js" type="text/javascript"></script>
    <script src="src/ast/ast_Set.js" type="text/javascript"></script>
    <script src="src/ast/ast_Dict.js" type="text/javascript"></script>
    <script src="src/ast/ast_Starred.js" type="text/javascript"></script>
    <script src="src/ast/ast_IfExp.js" type="text/javascript"></script>
    <script src="src/ast/ast_Attribute.js" type="text/javascript"></script>
    <script src="src/ast/ast_Call.js" type="text/javascript"></script>
    <script src="src/ast/ast_Raise.js" type="text/javascript"></script>
    <script src="src/ast/ast_Delete.js" type="text/javascript"></script>
    <script src="src/ast/ast_Subscript.js" type="text/javascript"></script>
    <script src="src/ast/ast_Comp.js" type="text/javascript"></script>
    <script src="src/ast/ast_FunctionDef.js" type="text/javascript"></script>
    <script src="src/ast/ast_Lambda.js" type="text/javascript"></script>
    <script src="src/ast/ast_Return.js" type="text/javascript"></script>
    <script src="src/ast/ast_Yield.js" type="text/javascript"></script>
    <script src="src/ast/ast_YieldFrom.js" type="text/javascript"></script>
    <script src="src/ast/ast_Global.js" type="text/javascript"></script>
    <!--<script src="/src/ast/ast_Nonlocal.js" type="text/javascript"></script>-->
    <script src="src/ast/ast_Break.js" type="text/javascript"></script>
    <script src="src/ast/ast_Continue.js" type="text/javascript"></script>
    <script src="src/ast/ast_Try.js" type="text/javascript"></script>
    <script src="src/ast/ast_ClassDef.js" type="text/javascript"></script>
    <script src="src/ast/ast_Import.js" type="text/javascript"></script>
    <script src="src/ast/ast_With.js" type="text/javascript"></script>
    <script src="src/ast/ast_Comment.js" type="text/javascript"></script>
    <script src="src/ast/ast_Raw.js" type="text/javascript"></script>
  </head>
  
  <body>
    <div class="container-fluid">
      <p>Python積木方塊</p>
      <!-- 文字置中 -->

      <div
        class="btn-group"
        role="group"
        aria-label="Basic radio toggle button group"
      >
        <input
          type="radio"
          class="btn-check"
          name="btnradio"
          id="btnradio1"
          autocomplete="off"
        />
        <label
          class="btn btn-outline-primary"
          for="btnradio1"
          onclick="editor.setMode('block');"
          >積木</label
        >

        <input
          type="radio"
          class="btn-check"
          name="btnradio"
          id="btnradio2"
          autocomplete="off"
          checked
        />
        <label
          class="btn btn-outline-primary"
          for="btnradio2"
          onclick="editor.setMode('split');"
          >同時顯示</label
        >
        <input
          type="radio"
          class="btn-check"
          name="btnradio"
          id="btnradio3"
          autocomplete="off"
        />
        <label
          class="btn btn-outline-primary"
          for="btnradio3"
          onclick="editor.setMode('text');"
          >僅程式碼</label
        >
      </div>

      
      <!-- 從本機上傳檔案 -->

     
      <form
        id="upload-form"
        method="post"
      >

       <div class="input-group">
          <input
            type="file"
            class="form-control"
            name="file"
            id="file"
            aria-describedby="upload"
            aria-label="upload"
          />
          <button class="btn btn-outline-secondary" type="button" id="upload">
            讀取檔案
          </button>
      </form>
      </div>
      </div>

      <!--  <button class="btn btn-primary" type="button" onclick="runit()">
        執行程式
      </button> -->

      
 <!--<div>
        <h3>輸出結果</h3>
        <h1 id="output"></h1>
        <!-- 可以輸出圖表 -->
       <!--  <div id="mycanvas"></div> -->
        <!-- <div id="root"></div> -->
    <!--</div> --> 


    <div class="controltool">
        <button type="button" class="btn btn-primary" id="go">
          取得程式碼
        </button>
        <button type="button" class="btn btn-primary" id="changetheme">
          暗黑模式
        </button>
        <button type="button" class="btn btn-primary" id="run">輸出範例</button>
        <button type="button" class="btn btn-primary" id="reset">重置</button>
        <button type="button" class="btn btn-primary" id="download">匯出</button>
        
      </div>


      <div id="blockmirror-editor"></div>

      <script>
        function changeTheme() {
          var theme = document.getElementById("themeChanger");
          Blockly.getMainWorkspace().setTheme(Blockly.Themes.Dark);
        }
      </script>
      <script>
        const configuration = {
          container: document.getElementById("blockmirror-editor"),
          blocklyMediaPath: "media/",
          skipSkulpt: false,
          toolbox: "minimal", //顯示不同工具箱 ct2,full,normal,minimal,empty
          height: 800,
        };
        let editor = new BlockMirror(configuration);

        /* 設定預設Python程式碼 */
        editor.setCode("");

        $("#go").click(function () {
          var code = editor.getCode();
          console.log(code);
          alert(code);
        });

        $("#run").click(function () {
          editor.blockEditor.setCode(
            'class X:\n    """こんにちは"""\ndef add(self, a, b):\n        a = 0\n        return a\n\nx = X()\nx.add(5,3)'
          );
        });

        $("#reset").click(function () {
         const swalWithBootstrapButtons = Swal.mixin({
                customClass: {
                  confirmButton: 'btn btn-success',
                  cancelButton: 'btn btn-danger'
                },
                
              })

              swalWithBootstrapButtons.fire({
                title: '確定嗎?',
                text: "您將無法還原此內容!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '清除',
                cancelButtonText: '取消',
                reverseButtons: true
              }).then((result) => {
                if (result.isConfirmed) {
                  swalWithBootstrapButtons.fire(
                    '已清除!',
                    '您的程式碼已全部清除',
                    'success'
                  )
                  editor.blockEditor.setCode("");
                } else if (
                  /* Read more about handling dismissals below */
                  result.dismiss === Swal.DismissReason.cancel
                ) {
                  swalWithBootstrapButtons.fire(
                    '取消',
                    '您的程式碼已保留 :)',
                    'info'
                  )
                }
              })
        });

        $("#changetheme").click(function () {
          Blockly.getMainWorkspace().setTheme(Blockly.Themes.Dark);
        });




        /* 在警示視窗輸入名稱並下載副檔名為.py */
        $("#download").click(function () {
          var code = editor.getCode();
          swal.fire({
              showCancelButton:true,
              title: "請輸入檔案名稱",
              inputAttributes: {
                autocapitalize: "off"
              },
              confirmButtonText: "確定",
              cancelButtonText: "取消",
              
              html:`<input class="input-group-text" id="input1" type="text">`,
              

              preConfirm:
              function()
              {
                filename= $('#input1').val();
                console.log(filename); // use user input value freely 
                
                if (filename === "") {
                  Swal.fire(
                    '尚未輸入檔名',
                    '請再輸入一次檔案名稱',
                    'question'
                )
                }else{

                  var pom = document.createElement("a");
                  pom.setAttribute(
                    "href",
                    "data:text/plain;charset=utf-8," + encodeURIComponent(code)
                  );
                  if (filename) {
                    pom.setAttribute("download", filename + ".py");

                  }
                  pom.click();

                  
                  /* 清空filename */
                  filename = "";
                }
                
            }
         }) // end of swal;
 
        });



        function outf(text) {
          var mypre = document.getElementById("output");
          mypre.innerHTML = mypre.innerHTML + text;
        }
        function builtinRead(x) {
          if (
            Sk.builtinFiles === undefined ||
            Sk.builtinFiles["files"][x] === undefined
          )
            throw "File not found: '" + x + "'";
          return Sk.builtinFiles["files"][x];
        }


         





        // Here's everything you need to run a python program in skulpt
        // grab the code from your textarea
        // get a reference to your pre element for output
        // configure the output function
        // call Sk.importMainWithBody()
        function runit() {
          var prog = editor.getCode();
          var mypre = document.getElementById("output");
          mypre.innerHTML = "";
          Sk.pre = "output";
          Sk.configure({ output: outf, read: builtinRead });
          (Sk.TurtleGraphics || (Sk.TurtleGraphics = {})).target = "mycanvas";
          var myPromise = Sk.misceval.asyncToPromise(function () {
            return Sk.importMainWithBody("<stdin>", false, prog, true);
          });
          myPromise.then(
            function (mod) {
              console.log("success");
            },
            function (err) {
              console.log(err.toString());
            }
          );
        }

   

        /* 讀取檔案 */

        $("#upload").click(function () {
          var file = $("#file")[0].files[0];
          var reader = new FileReader();
          reader.onload = function (e) {
            var contents = e.target.result;
            /* 去除contents 空白段落 */
            contents = contents.replace(/\n\s*\n/g, "\n");
            editor.blockEditor.setCode(contents);
          };
          reader.readAsText(file);
        });
      </script>
    </div>
  </body>
</html>
